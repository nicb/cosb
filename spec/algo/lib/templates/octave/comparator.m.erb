%
% comparator.m.erb:
%
% this is used to compare csound and octave outputs
%
pkg load signal;
pkg load statistics;

[csound_sig c_sr] = audioread("<%= self.in_csound_file %>");
[octave_sig o_sr] = audioread("<%= self.in_octave_file %>");

if (length(csound_sig) != length(octave_sig))
  fprintf(STDERR, "csound and octave lengths differ: (%d != %d)\n", length(csound_sig), length(octave_sig));
  exit(-1);
end
if (c_sr != o_sr)
  fprintf(STDERR, "csound and octave sampling rates differ: (%d != %d)\n", c_sr, o_sr);
  exit(-2);
end

sr = c_sr;
sinc = 1/sr;
dur = length(csound_sig)/sr;
t = [0:sinc:dur-sinc]';
offset = dur/2;
s_offset = round(offset * sr);

diff_left = abs(csound_sig(:,1) .- octave_sig(:,1));
diff_right = abs(csound_sig(:,2) .- octave_sig(:,2));

devtn = [ sum(diff_left) sum(diff_right) ];

oifh = fopen("<%= self.out_info_file %>", "a");
if (oifh < 0)
  ferror(oifh);
  exit(-3);
end
fprintf(oifh, "  error: [%.8f, %.8f] # left, right\n", devtn(1), devtn(2));
fclose(oifh);

figure(1, "visible", "off")
title("csound/octave differences")
subplot(2,1,1)
  plot(t, diff_left, ';left channel;')
  axis([offset dur])
subplot(2,1,2)
  plot(t, diff_right, ';right channel;')
  axis([offset dur])

print("<%= self.output_plot_root %>.pdf", "-dpdf")

ymax = max(max(max(csound_sig(:,1)),max(octave_sig(:,1))), max(max(csound_sig(:,2)), max(octave_sig(:,2))));
ymax *= 1.1;

figure(2, "visible", "off")
subplot(4,2,1)
  plot(t, csound_sig(:,1), ';csound;');
  axis([offset dur -ymax/100 ymax*1.1])
subplot(4,2,2)
  plot(t, octave_sig(:,1), ';octave;')
  axis([offset dur -ymax/100 ymax*1.1])
subplot(4,2,3)
  plot(t, csound_sig(:,2), ';csound;')
  axis([offset dur -ymax/100 ymax*1.1])
subplot(4,2,4)
  plot(t, octave_sig(:,2), ';octave;')
  axis([offset dur -ymax/100 ymax*1.1])

print("<%= self.output_plot_root %>.pdf", "-dpdf", "-append")
